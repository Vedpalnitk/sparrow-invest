// Prisma schema for Mutual Funds Investment Advisory Platform
// ONDC FIS14 v2.1.0 Compatible

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================
// ONDC ENUMS
// =============================================

enum SchemeStatus {
  active
  suspended
}

enum PlanType {
  regular
  direct
  retail
  institutional
}

enum OptionType {
  growth
  bonus
  idcw
  daily_idcw
  weekly_idcw
  monthly_idcw
  fortnightly_idcw
  quarterly_idcw
  half_yearly_idcw
  annual_idcw
}

enum IdcwOptionType {
  payout
  reinvestment
}

enum TransactionType {
  nfo_purchase
  fresh_purchase
  additional_purchase
  redemption
  switch_in
  switch_out
  sip
  swp
  stp_in
  stp_out
}

enum SystematicFrequency {
  daily
  weekly
  four_times_a_month
  fortnightly
  twice_a_month
  monthly
  quarterly
  half_yearly
  yearly
}

enum OrderType {
  PURCHASE
  REDEMPTION
}

enum OrderState {
  CREATED
  ACCEPTED
  REJECTED
}

enum FulfillmentType {
  LUMPSUM
  SIP
  REDEMPTION
  SIP_INSTALMENT
}

enum FulfillmentState {
  ONGOING
  COMPLETED
  CANCELLED
  SUCCESSFUL
  FAILED
}

enum PaymentType {
  EXISTING_MANDATE
  NEW_MANDATE_REGISTRATION
  NETBANKING
  UPI_COLLECT
  MANDATE_DEBIT
}

enum PaymentState {
  PAID
  NOT_PAID
  FAILED
}

// =============================================
// ONDC CATEGORIES (3-Level Taxonomy)
// =============================================

model Category {
  id          String   @id
  level       Int // 1, 2, or 3
  parentId    String?  @map("parent_id")
  name        String
  code        String // Short code for ONDC
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  schemes  Scheme[]

  @@map("categories")
}

// =============================================
// ONDC PROVIDERS (AMC/Fund Houses)
// =============================================

model Provider {
  id               String   @id
  name             String
  shortName        String?  @map("short_name")
  rtaIdentifier    String?  @map("rta_identifier")
  sebiRegNo        String?  @map("sebi_reg_no")
  logoUrl          String?  @map("logo_url")
  websiteUrl       String?  @map("website_url")
  contactEmail     String?  @map("contact_email")
  contactPhone     String?  @map("contact_phone")
  address          String?
  isActive         Boolean  @default(true) @map("is_active")
  ondcSubscriberId String?  @map("ondc_subscriber_id")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  schemes         Scheme[]
  commissionRates CommissionRateMaster[]

  @@map("providers")
}

// =============================================
// ONDC SCHEMES (Parent Item - Base Scheme)
// =============================================

model Scheme {
  id                  String       @id
  providerId          String       @map("provider_id")
  status              SchemeStatus @default(active)
  name                String
  categoryId          String       @map("category_id")
  subCategory         String?      @map("sub_category")
  lockinPeriod        Int?         @map("lockin_period") // Days
  nfoStart            DateTime?    @map("nfo_start") @db.Date
  nfoEnd              DateTime?    @map("nfo_end") @db.Date
  allotmentDate       DateTime?    @map("allotment_date") @db.Date
  reopenDate          DateTime?    @map("reopen_date") @db.Date
  faceValue           Decimal?     @default(10.0000) @map("face_value") @db.Decimal(10, 4)
  entryLoad           String?      @map("entry_load")
  exitLoad            String?      @map("exit_load")
  benchmark           String?
  fundManager         String?      @map("fund_manager")
  investmentObjective String?      @map("investment_objective")
  mfapiSchemeCode     Int?         @map("mfapi_scheme_code")
  createdAt           DateTime     @default(now()) @map("created_at")
  updatedAt           DateTime     @updatedAt @map("updated_at")

  provider    Provider     @relation(fields: [providerId], references: [id])
  category    Category     @relation(fields: [categoryId], references: [id])
  schemePlans SchemePlan[]

  @@index([providerId])
  @@index([categoryId])
  @@index([status])
  @@index([mfapiSchemeCode])
  @@map("schemes")
}

// =============================================
// ONDC SCHEME PLANS (Child Item - ISIN-level)
// =============================================

model SchemePlan {
  id                String          @id
  schemeId          String          @map("scheme_id")
  isin              String          @unique
  rtaIdentifier     String          @map("rta_identifier")
  amfiIdentifier    String?         @map("amfi_identifier")
  status            SchemeStatus    @default(active)
  name              String
  plan              PlanType
  option            OptionType
  idcwOption        IdcwOptionType? @map("idcw_option")
  purchaseAllowed   Boolean         @default(true) @map("purchase_allowed")
  redemptionAllowed Boolean         @default(true) @map("redemption_allowed")
  switchInAllowed   Boolean         @default(true) @map("switch_in_allowed")
  switchOutAllowed  Boolean         @default(true) @map("switch_out_allowed")
  sipAllowed        Boolean         @default(true) @map("sip_allowed")
  swpAllowed        Boolean         @default(false) @map("swp_allowed")
  stpInAllowed      Boolean         @default(false) @map("stp_in_allowed")
  stpOutAllowed     Boolean         @default(false) @map("stp_out_allowed")
  mfapiSchemeCode   Int?            @map("mfapi_scheme_code")
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")

  scheme     Scheme                 @relation(fields: [schemeId], references: [id], onDelete: Cascade)
  thresholds Threshold[]
  nav        SchemePlanNav?
  metrics    SchemePlanMetrics?
  navHistory SchemePlanNavHistory[]
  platform   SchemePlanPlatform?
  watchlists UserWatchlist[]

  @@index([schemeId])
  @@index([plan])
  @@index([status])
  @@index([mfapiSchemeCode])
  @@map("scheme_plans")
}

// =============================================
// ONDC THRESHOLDS (Fulfillment Rules)
// =============================================

model Threshold {
  id                       Int                  @id @default(autoincrement())
  schemePlanId             String               @map("scheme_plan_id")
  transactionType          TransactionType      @map("transaction_type")
  systematicFrequency      SystematicFrequency? @map("systematic_frequency")
  systematicFrequencyDates String?              @map("systematic_frequency_dates")
  amountMin                Decimal?             @map("amount_min") @db.Decimal(14, 2)
  amountMax                Decimal?             @map("amount_max") @db.Decimal(14, 2)
  amountMultiples          Decimal?             @default(1) @map("amount_multiples") @db.Decimal(10, 2)
  unitsMin                 Decimal?             @map("units_min") @db.Decimal(14, 4)
  unitsMax                 Decimal?             @map("units_max") @db.Decimal(14, 4)
  unitsMultiples           Decimal?             @map("units_multiples") @db.Decimal(10, 4)
  installmentsCountMin     Int?                 @map("installments_count_min")
  installmentsCountMax     Int?                 @map("installments_count_max")
  cumulativeAmountMin      Decimal?             @map("cumulative_amount_min") @db.Decimal(14, 2)
  createdAt                DateTime             @default(now()) @map("created_at")
  updatedAt                DateTime             @updatedAt @map("updated_at")

  schemePlan SchemePlan @relation(fields: [schemePlanId], references: [id], onDelete: Cascade)

  @@unique([schemePlanId, transactionType, systematicFrequency])
  @@index([schemePlanId])
  @@index([transactionType])
  @@map("thresholds")
}

// =============================================
// NAV DATA (Real-time/Daily)
// =============================================

model SchemePlanNav {
  id           Int      @id @default(autoincrement())
  schemePlanId String   @unique @map("scheme_plan_id")
  navDate      DateTime @map("nav_date") @db.Date
  nav          Decimal  @db.Decimal(14, 4)
  dayChange    Decimal? @map("day_change") @db.Decimal(10, 4)
  dayChangePct Decimal? @map("day_change_pct") @db.Decimal(8, 4)
  updatedAt    DateTime @updatedAt @map("updated_at")

  schemePlan SchemePlan @relation(fields: [schemePlanId], references: [id], onDelete: Cascade)

  @@map("scheme_plan_nav")
}

// =============================================
// RETURNS & METRICS
// =============================================

model SchemePlanMetrics {
  id                   Int       @id @default(autoincrement())
  schemePlanId         String    @unique @map("scheme_plan_id")
  return1w             Decimal?  @map("return_1w") @db.Decimal(8, 4)
  return1m             Decimal?  @map("return_1m") @db.Decimal(8, 4)
  return3m             Decimal?  @map("return_3m") @db.Decimal(8, 4)
  return6m             Decimal?  @map("return_6m") @db.Decimal(8, 4)
  return1y             Decimal?  @map("return_1y") @db.Decimal(8, 4)
  return3y             Decimal?  @map("return_3y") @db.Decimal(8, 4)
  return5y             Decimal?  @map("return_5y") @db.Decimal(8, 4)
  return10y            Decimal?  @map("return_10y") @db.Decimal(8, 4)
  returnSinceInception Decimal?  @map("return_since_inception") @db.Decimal(8, 4)
  riskRating           Int?      @map("risk_rating") // 1-5
  crisilRating         String?   @map("crisil_rating")
  fundRating           Int?      @map("fund_rating") // Star rating 1-5
  volatility           Decimal?  @db.Decimal(8, 4)
  sharpeRatio          Decimal?  @map("sharpe_ratio") @db.Decimal(8, 4)
  sortinoRatio         Decimal?  @map("sortino_ratio") @db.Decimal(8, 4)
  alpha                Decimal?  @db.Decimal(8, 4)
  beta                 Decimal?  @db.Decimal(8, 4)
  maxDrawdown          Decimal?  @map("max_drawdown") @db.Decimal(8, 4)
  expenseRatio         Decimal?  @map("expense_ratio") @db.Decimal(6, 4)
  aum                  Decimal?  @db.Decimal(16, 2) // In Crores
  aumDate              DateTime? @map("aum_date") @db.Date
  updatedAt            DateTime  @updatedAt @map("updated_at")

  schemePlan SchemePlan @relation(fields: [schemePlanId], references: [id], onDelete: Cascade)

  @@map("scheme_plan_metrics")
}

// =============================================
// NAV HISTORY (For Charts)
// =============================================

model SchemePlanNavHistory {
  id           Int      @id @default(autoincrement())
  schemePlanId String   @map("scheme_plan_id")
  navDate      DateTime @map("nav_date") @db.Date
  nav          Decimal  @db.Decimal(14, 4)

  schemePlan SchemePlan @relation(fields: [schemePlanId], references: [id], onDelete: Cascade)

  @@unique([schemePlanId, navDate])
  @@index([schemePlanId, navDate(sort: Desc)])
  @@map("scheme_plan_nav_history")
}

// =============================================
// PLATFORM-SPECIFIC DATA
// =============================================

model SchemePlanPlatform {
  id             Int      @id @default(autoincrement())
  schemePlanId   String   @unique @map("scheme_plan_id")
  isRecommended  Boolean  @default(false) @map("is_recommended")
  isFeatured     Boolean  @default(false) @map("is_featured")
  displayOrder   Int?     @map("display_order")
  tags           String[] // ['top-performer', 'tax-saver', 'beginner-friendly']
  advisorNotes   String?  @map("advisor_notes")
  aiScore        Decimal? @map("ai_score") @db.Decimal(5, 2)
  riskMatchScore Decimal? @map("risk_match_score") @db.Decimal(5, 2)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  schemePlan SchemePlan @relation(fields: [schemePlanId], references: [id], onDelete: Cascade)

  @@index([isRecommended])
  @@map("scheme_plan_platform")
}

// =============================================
// ONDC ORDERS (For Transaction Support)
// =============================================

model Order {
  id              String          @id @default(uuid())
  ondcOrderId     String?         @unique @map("ondc_order_id")
  userId          String
  schemePlanId    String          @map("scheme_plan_id")
  orderType       OrderType       @map("order_type")
  orderState      OrderState      @default(CREATED) @map("order_state")
  fulfillmentType FulfillmentType @map("fulfillment_type")
  amount          Decimal?        @db.Decimal(14, 2)
  units           Decimal?        @db.Decimal(14, 4)
  nav             Decimal?        @db.Decimal(14, 4)
  folioNumber     String?         @map("folio_number")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  user        User         @relation(fields: [userId], references: [id])
  fulfillment Fulfillment?
  payment     Payment?

  @@index([userId])
  @@index([schemePlanId])
  @@index([orderState])
  @@map("orders")
}

model Fulfillment {
  id                    String               @id @default(uuid())
  orderId               String               @unique @map("order_id")
  fulfillmentState      FulfillmentState     @default(ONGOING) @map("fulfillment_state")
  sipStartDate          DateTime?            @map("sip_start_date") @db.Date
  sipEndDate            DateTime?            @map("sip_end_date") @db.Date
  sipFrequency          SystematicFrequency? @map("sip_frequency")
  sipDay                Int?                 @map("sip_day")
  totalInstallments     Int?                 @map("total_installments")
  completedInstallments Int?                 @default(0) @map("completed_installments")
  unitsAllotted         Decimal?             @map("units_allotted") @db.Decimal(14, 4)
  allotmentDate         DateTime?            @map("allotment_date") @db.Date
  allotmentNav          Decimal?             @map("allotment_nav") @db.Decimal(14, 4)
  createdAt             DateTime             @default(now()) @map("created_at")
  updatedAt             DateTime             @updatedAt @map("updated_at")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("fulfillments")
}

model Payment {
  id                String       @id @default(uuid())
  orderId           String       @unique @map("order_id")
  paymentType       PaymentType  @map("payment_type")
  paymentState      PaymentState @default(NOT_PAID) @map("payment_state")
  amount            Decimal      @db.Decimal(14, 2)
  transactionId     String?      @map("transaction_id")
  mandateId         String?      @map("mandate_id")
  bankAccountMasked String?      @map("bank_account_masked")
  paymentUrl        String?      @map("payment_url")
  paidAt            DateTime?    @map("paid_at")
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("payments")
}

// =============================================
// INVESTOR FOLIOS (For ONDC)
// =============================================

model Folio {
  id                String   @id @default(uuid())
  userId            String
  providerId        String   @map("provider_id")
  folioNumber       String   @map("folio_number")
  panNumber         String   @map("pan_number")
  bankAccountMasked String?  @map("bank_account_masked")
  kycStatus         String   @default("pending") @map("kyc_status") // pending, verified, rejected
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  user     User      @relation(fields: [userId], references: [id])
  holdings Holding[]

  @@unique([userId, providerId, folioNumber])
  @@index([userId])
  @@index([providerId])
  @@map("folios")
}

model Holding {
  id             String   @id @default(uuid())
  folioId        String   @map("folio_id")
  schemePlanId   String   @map("scheme_plan_id")
  units          Decimal  @db.Decimal(14, 4)
  investedAmount Decimal  @map("invested_amount") @db.Decimal(14, 2)
  currentValue   Decimal? @map("current_value") @db.Decimal(14, 2)
  averageNav     Decimal? @map("average_nav") @db.Decimal(14, 4)
  lastUpdatedAt  DateTime @default(now()) @map("last_updated_at")
  createdAt      DateTime @default(now()) @map("created_at")

  folio Folio @relation(fields: [folioId], references: [id], onDelete: Cascade)

  @@unique([folioId, schemePlanId])
  @@map("holdings")
}

// =============================================
// PERSONA MANAGEMENT
// =============================================

model Persona {
  id             String   @id @default(uuid())
  name           String   @unique
  slug           String   @unique
  description    String?
  riskBand       String // 'Capital Preservation', 'Balanced Growth', 'Accelerated Growth'
  iconName       String?
  colorPrimary   String?
  colorSecondary String?
  displayOrder   Int      @default(0)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  rules        PersonaRule[]
  insights     PersonaInsight[]
  mlMappings   PersonaMlMapping[]
  allocations  AllocationStrategy[]
  userProfiles UserProfile[]

  @@map("personas")
}

model PersonaRule {
  id        String   @id @default(uuid())
  personaId String
  ruleType  String // 'horizon', 'liquidity', 'risk_tolerance', 'volatility'
  operator  String // 'eq', 'lte', 'gte', 'lt', 'gt', 'in'
  value     Json
  priority  Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  persona Persona @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@map("persona_rules")
}

model PersonaInsight {
  id           String   @id @default(uuid())
  personaId    String
  insightText  String
  displayOrder Int      @default(0)
  createdAt    DateTime @default(now())

  persona Persona @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@map("persona_insights")
}

model PersonaMlMapping {
  id           String   @id @default(uuid())
  personaId    String
  modelId      String?
  modelPurpose String // 'classification', 'optimization', 'recommendation'
  weight       Float    @default(1.0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())

  persona Persona  @relation(fields: [personaId], references: [id], onDelete: Cascade)
  model   MlModel? @relation(fields: [modelId], references: [id], onDelete: SetNull)

  @@map("persona_ml_mappings")
}

// =============================================
// ALLOCATION STRATEGIES
// =============================================

model AllocationStrategy {
  id             String    @id @default(uuid())
  personaId      String
  name           String
  description    String?
  version        Int       @default(1)
  isActive       Boolean   @default(true)
  effectiveFrom  DateTime?
  effectiveUntil DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  persona     Persona               @relation(fields: [personaId], references: [id], onDelete: Cascade)
  components  AllocationComponent[]
  constraints RiskConstraint[]

  @@map("allocation_strategies")
}

model AllocationComponent {
  id                 String   @id @default(uuid())
  strategyId         String
  label              String
  allocationPercent  Float
  note               String?
  fundCategoryFilter Json?
  riskLevel          String?
  displayOrder       Int      @default(0)
  createdAt          DateTime @default(now())

  strategy AllocationStrategy @relation(fields: [strategyId], references: [id], onDelete: Cascade)

  @@map("allocation_components")
}

model RiskConstraint {
  id              String   @id @default(uuid())
  strategyId      String
  constraintType  String
  constraintValue Float
  description     String?
  createdAt       DateTime @default(now())

  strategy AllocationStrategy @relation(fields: [strategyId], references: [id], onDelete: Cascade)

  @@map("risk_constraints")
}

// =============================================
// ML MODEL MANAGEMENT
// =============================================

model MlModel {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  modelType   String
  description String?
  framework   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  versions        ModelVersion[]
  personaMappings PersonaMlMapping[]
  abTests         AbTest[]
  inferenceLogs   MlInferenceLog[]

  @@map("ml_models")
}

model ModelVersion {
  id            String    @id @default(uuid())
  modelId       String
  version       String
  storagePath   String
  fileSizeBytes BigInt?
  metadata      Json?
  metrics       Json?
  status        String    @default("staged")
  isProduction  Boolean   @default(false)
  trainedAt     DateTime?
  createdAt     DateTime  @default(now())

  model            MlModel          @relation(fields: [modelId], references: [id], onDelete: Cascade)
  controlAbTests   AbTest[]         @relation("ControlVersion")
  treatmentAbTests AbTest[]         @relation("TreatmentVersion")
  abTestResults    AbTestResult[]
  inferenceLogs    MlInferenceLog[]

  @@unique([modelId, version])
  @@map("model_versions")
}

model AbTest {
  id                 String    @id @default(uuid())
  name               String
  description        String?
  modelId            String
  controlVersionId   String
  treatmentVersionId String
  trafficSplit       Float     @default(0.5)
  status             String    @default("draft")
  startDate          DateTime?
  endDate            DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  model            MlModel        @relation(fields: [modelId], references: [id], onDelete: Cascade)
  controlVersion   ModelVersion   @relation("ControlVersion", fields: [controlVersionId], references: [id])
  treatmentVersion ModelVersion   @relation("TreatmentVersion", fields: [treatmentVersionId], references: [id])
  results          AbTestResult[]

  @@map("ab_tests")
}

model AbTestResult {
  id              String   @id @default(uuid())
  abTestId        String
  userId          String?
  versionId       String
  requestPayload  Json?
  responsePayload Json?
  latencyMs       Int?
  createdAt       DateTime @default(now())

  abTest  AbTest       @relation(fields: [abTestId], references: [id], onDelete: Cascade)
  version ModelVersion @relation(fields: [versionId], references: [id])

  @@map("ab_test_results")
}

// =============================================
// USER MANAGEMENT
// =============================================

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  phone        String?
  passwordHash String
  isActive     Boolean   @default(true)
  isVerified   Boolean   @default(false)
  role         String    @default("user")
  lastLoginAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  profile            UserProfile?
  portfolioSnapshots UserPortfolioSnapshot[]
  watchlist          UserWatchlist[]
  apiLogs            ApiLog[]
  inferenceLogs      MlInferenceLog[]
  orders             Order[]
  folios             Folio[]

  // FA Portal Relations
  advisorClients     FAClient[] @relation("AdvisorClients") // Clients managed by this advisor
  clientProfile      FAClient?  @relation("ClientUser")     // If user is also an FA client

  // New Relations (Goals, Points, Portfolio History, etc.)
  goals              UserGoal[]
  points             UserPoints?
  portfolioHistory   UserPortfolioHistory[]
  taxSummaries       UserTaxSummary[]
  dividends          DividendRecord[]
  connectedAccounts  ConnectedBrokerAccount[]
  advisorProfile     AdvisorProfile?
  advisorReviews     AdvisorReview[]   @relation("ReviewerReviews")
  chatSessions       AIChatSession[]
  actions            UserAction[]
  notificationPrefs  NotificationPreference[]
  notificationLogs   NotificationLog[]
  savedAnalyses      SavedAnalysis[] @relation("AdvisorSavedAnalyses")
  communications     FACommunicationLog[] @relation("AdvisorCommunications")
  ownedStaff         FAStaffMember[] @relation("FAStaffOwner")
  staffProfile       FAStaffMember? @relation("FAStaffUser")

  // Business Management Relations
  branches           Branch[]
  commissionRates    CommissionRateMaster[]
  commissionRecords  CommissionRecord[]
  brokerageUploads   BrokerageUpload[]
  aumSnapshots       AUMSnapshot[]
  crmTasks           CRMTask[]       @relation("TaskAdvisor")
  crmActivities      CRMActivityLog[] @relation("ActivityAdvisor")
  complianceRecords  ComplianceRecord[]
  auditLogs          AuditLog[]

  @@map("users")
}

model UserProfile {
  id                  String    @id @default(uuid())
  userId              String    @unique
  name                String
  age                 Int?
  city                String?
  panNumber           String?
  dateOfBirth         DateTime? @db.Date
  goal                String?
  targetAmount        Float?
  targetYear          Int?
  monthlySip          Float?
  lumpSum             Float?
  liquidity           String?
  riskTolerance       String?
  knowledge           String?
  volatility          String?
  horizonYears        Int?
  assignedPersonaId   String?
  personaAssignedAt   DateTime?
  personaMethod       String?
  personaDistribution Json?
  blendedAllocation   Json?
  kycStatus           String    @default("pending")
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  persona Persona? @relation(fields: [assignedPersonaId], references: [id])

  @@map("user_profiles")
}

model UserPortfolioSnapshot {
  id                 String   @id @default(uuid())
  userId             String
  snapshotDate       DateTime @db.Date
  totalValue         Float?
  allocationSnapshot Json?
  fundsSnapshot      Json?
  createdAt          DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_portfolio_snapshots")
}

model UserWatchlist {
  id           String   @id @default(uuid())
  userId       String
  schemePlanId String   @map("scheme_plan_id")
  addedAt      DateTime @default(now())

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  schemePlan SchemePlan @relation(fields: [schemePlanId], references: [id], onDelete: Cascade)

  @@unique([userId, schemePlanId])
  @@map("user_watchlists")
}

// =============================================
// ANALYTICS & AUDIT
// =============================================

model ApiLog {
  id             String   @id @default(uuid())
  userId         String?
  endpoint       String?
  method         String?
  requestPayload Json?
  responseStatus Int?
  latencyMs      Int?
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@map("api_logs")
}

model PersonaAnalytics {
  id              String   @id @default(uuid())
  date            DateTime @db.Date
  personaId       String?
  userCount       Int      @default(0)
  newUsers        Int      @default(0)
  avgSipAmount    Float?
  avgTargetAmount Float?
  createdAt       DateTime @default(now())

  @@unique([date, personaId])
  @@map("persona_analytics")
}

model MlInferenceLog {
  id            String   @id @default(uuid())
  modelId       String?
  versionId     String?
  userId        String?
  inputFeatures Json?
  prediction    Json?
  confidence    Float?
  latencyMs     Int?
  createdAt     DateTime @default(now())

  model   MlModel?      @relation(fields: [modelId], references: [id])
  version ModelVersion? @relation(fields: [versionId], references: [id])
  user    User?         @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@map("ml_inference_logs")
}

// =============================================
// DATA SYNC TRACKING
// =============================================

model DataSyncLog {
  id            Int       @id @default(autoincrement())
  syncType      String    @map("sync_type") // 'mfapi_nav', 'kuvera_metrics', 'ondc_catalog'
  status        String // 'started', 'completed', 'failed'
  recordsTotal  Int?      @map("records_total")
  recordsSynced Int?      @map("records_synced")
  recordsFailed Int?      @map("records_failed")
  errorMessage  String?   @map("error_message")
  startedAt     DateTime  @default(now()) @map("started_at")
  completedAt   DateTime? @map("completed_at")

  @@index([syncType, startedAt(sort: Desc)])
  @@map("data_sync_logs")
}

// =============================================
// FA PORTAL - CLIENT MANAGEMENT
// =============================================

enum FAClientStatus {
  ACTIVE
  INACTIVE
  PENDING_KYC
}

enum FAKycStatus {
  VERIFIED
  PENDING
  EXPIRED
}

enum FARiskProfile {
  CONSERVATIVE
  MODERATE
  AGGRESSIVE
}

enum InsurancePolicyType {
  TERM_LIFE
  WHOLE_LIFE
  ENDOWMENT
  ULIP
  HEALTH
  CRITICAL_ILLNESS
  PERSONAL_ACCIDENT
  OTHER
}

enum InsurancePolicyStatus {
  ACTIVE
  LAPSED
  SURRENDERED
  MATURED
  CLAIMED
}

model FAClient {
  id           String         @id @default(uuid())
  advisorId    String         @map("advisor_id")
  userId       String?        @unique @map("user_id") // Link to User if they have app login
  name         String
  email        String
  phone        String
  pan          String?
  dateOfBirth  DateTime?      @map("date_of_birth") @db.Date
  address      String?
  city         String?
  state        String?
  pincode      String?
  riskProfile  FARiskProfile  @default(MODERATE) @map("risk_profile")
  status       FAClientStatus @default(PENDING_KYC)
  kycStatus    FAKycStatus    @default(PENDING) @map("kyc_status")
  nomineeName  String?        @map("nominee_name")
  nomineeRelation String?     @map("nominee_relation")
  nomineePercent  Int?        @map("nominee_percent")
  // Family grouping fields
  familyGroupId   String?     @map("family_group_id") // UUID to group family members
  familyRole      String?     @map("family_role") // SELF, SPOUSE, CHILD, PARENT, SIBLING
  familyHeadId    String?     @map("family_head_id") // Reference to primary family member
  assignedRmId    String?     @map("assigned_rm_id") // Staff member assigned as RM
  tags            String[]    @default([])
  importantDates  Json?       @map("important_dates") // { anniversary: "2025-06-15", ... }
  lastActiveAt DateTime?      @map("last_active_at")
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")

  advisor      User           @relation("AdvisorClients", fields: [advisorId], references: [id])
  user         User?          @relation("ClientUser", fields: [userId], references: [id])
  holdings     FAHolding[]
  transactions FATransaction[]
  sips         FASIP[]
  bankAccounts FABankAccount[]

  // New Relations
  goals            UserGoal[]
  portfolioHistory UserPortfolioHistory[]
  dividends        DividendRecord[]
  savedAnalyses    SavedAnalysis[]
  communications   FACommunicationLog[] @relation("ClientCommunications")
  insurancePolicies InsurancePolicy[]

  // Business Management Relations
  crmTasks         CRMTask[]
  crmActivities    CRMActivityLog[]

  @@unique([advisorId, email])
  @@index([advisorId])
  @@index([status])
  @@index([familyGroupId])
  @@index([assignedRmId])
  @@map("fa_clients")
}

model FABankAccount {
  id            String  @id @default(uuid())
  clientId      String  @map("client_id")
  bankName      String  @map("bank_name")
  accountNumber String  @map("account_number")
  ifsc          String
  accountType   String  @default("Savings") @map("account_type") // Savings, Current
  isPrimary     Boolean @default(false) @map("is_primary")
  mandateStatus String? @map("mandate_status") // Active, Pending, Expired

  client FAClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("fa_bank_accounts")
}

// =============================================
// FA PORTAL - PORTFOLIO & HOLDINGS
// =============================================

model FAHolding {
  id              String   @id @default(uuid())
  clientId        String   @map("client_id")
  schemePlanId    String?  @map("scheme_plan_id") // Link to actual scheme
  fundName        String   @map("fund_name")
  fundSchemeCode  String   @map("fund_scheme_code")
  fundCategory    String   @map("fund_category")
  assetClass      String   @map("asset_class")
  folioNumber     String   @map("folio_number")
  units           Decimal  @db.Decimal(14, 4)
  avgNav          Decimal  @map("avg_nav") @db.Decimal(14, 4)
  currentNav      Decimal  @map("current_nav") @db.Decimal(14, 4)
  investedValue   Decimal  @map("invested_value") @db.Decimal(14, 2)
  currentValue    Decimal  @map("current_value") @db.Decimal(14, 2)
  absoluteGain    Decimal  @map("absolute_gain") @db.Decimal(14, 2)
  absoluteGainPct Decimal  @map("absolute_gain_pct") @db.Decimal(8, 4)
  xirr            Decimal? @db.Decimal(8, 4)
  lastTxnDate     DateTime @map("last_txn_date") @db.Date
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  client FAClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, folioNumber, fundSchemeCode])
  @@index([clientId])
  @@map("fa_holdings")
}

// =============================================
// FA PORTAL - TRANSACTIONS
// =============================================

enum FATransactionType {
  BUY
  SELL
  SIP
  SWP
  SWITCH
  STP
}

enum FATransactionStatus {
  COMPLETED
  PENDING
  PROCESSING
  FAILED
  CANCELLED
}

model FATransaction {
  id             String              @id @default(uuid())
  clientId       String              @map("client_id")
  schemePlanId   String?             @map("scheme_plan_id")
  fundName       String              @map("fund_name")
  fundSchemeCode String              @map("fund_scheme_code")
  fundCategory   String              @map("fund_category")
  type           FATransactionType
  amount         Decimal             @db.Decimal(14, 2)
  units          Decimal             @db.Decimal(14, 4)
  nav            Decimal             @db.Decimal(14, 4)
  status         FATransactionStatus @default(PENDING)
  date           DateTime            @db.Date
  folioNumber    String              @map("folio_number")
  orderId        String?             @map("order_id")
  paymentMode    String?             @map("payment_mode") // Net Banking, UPI, NACH, Cheque
  remarks        String?
  sipId          String?             @map("sip_id") // Link to SIP if it's a SIP transaction
  createdAt      DateTime            @default(now()) @map("created_at")
  updatedAt      DateTime            @updatedAt @map("updated_at")

  client FAClient @relation(fields: [clientId], references: [id], onDelete: Cascade)
  sip    FASIP?   @relation(fields: [sipId], references: [id])

  @@index([clientId])
  @@index([status])
  @@index([date])
  @@map("fa_transactions")
}

// =============================================
// FA PORTAL - SIP MANAGEMENT
// =============================================

enum FASIPStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
  FAILED
}

enum FASIPFrequency {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
}

model FASIP {
  id                    String         @id @default(uuid())
  clientId              String         @map("client_id")
  schemePlanId          String?        @map("scheme_plan_id")
  fundName              String         @map("fund_name")
  fundSchemeCode        String         @map("fund_scheme_code")
  folioNumber           String         @map("folio_number")
  amount                Decimal        @db.Decimal(14, 2)
  frequency             FASIPFrequency @default(MONTHLY)
  sipDate               Int            @map("sip_date") // Day of month (1-28)
  startDate             DateTime       @map("start_date") @db.Date
  endDate               DateTime?      @map("end_date") @db.Date
  status                FASIPStatus    @default(ACTIVE)
  totalInstallments     Int            @default(0) @map("total_installments")
  completedInstallments Int            @default(0) @map("completed_installments")
  totalInvested         Decimal        @default(0) @map("total_invested") @db.Decimal(14, 2)
  currentValue          Decimal        @default(0) @map("current_value") @db.Decimal(14, 2)
  returns               Decimal        @default(0) @db.Decimal(14, 2)
  returnsPct            Decimal        @default(0) @map("returns_pct") @db.Decimal(8, 4)
  nextSipDate           DateTime       @map("next_sip_date") @db.Date
  lastSipDate           DateTime?      @map("last_sip_date") @db.Date
  mandateId             String?        @map("mandate_id")
  stepUpPercent         Int?           @map("step_up_percent")
  stepUpFrequency       String?        @map("step_up_frequency") // Yearly, Half-Yearly
  createdAt             DateTime       @default(now()) @map("created_at")
  updatedAt             DateTime       @updatedAt @map("updated_at")

  client       FAClient        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  transactions FATransaction[]

  @@index([clientId])
  @@index([status])
  @@index([nextSipDate])
  @@map("fa_sips")
}

// =============================================
// USER GOALS
// =============================================

enum GoalCategory {
  HOME
  RETIREMENT
  EDUCATION
  EMERGENCY
  WEDDING
  TRAVEL
  CAR
  WEALTH
  CUSTOM
}

enum GoalStatus {
  ACTIVE
  COMPLETED
  PAUSED
  CANCELLED
}

model UserGoal {
  id              String       @id @default(uuid())
  userId          String       @map("user_id")
  clientId        String?      @map("client_id")
  name            String
  category        GoalCategory
  icon            String?
  targetAmount    Decimal      @map("target_amount") @db.Decimal(14, 2)
  currentAmount   Decimal      @default(0) @map("current_amount") @db.Decimal(14, 2)
  targetDate      DateTime     @map("target_date") @db.Date
  monthlySip      Decimal?     @map("monthly_sip") @db.Decimal(14, 2)
  status          GoalStatus   @default(ACTIVE)
  priority        Int          @default(1)
  linkedFundCodes String[]     @map("linked_fund_codes")
  notes           String?
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  user          User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  client        FAClient?          @relation(fields: [clientId], references: [id])
  contributions GoalContribution[]

  @@index([userId])
  @@index([clientId])
  @@index([status])
  @@map("user_goals")
}

model GoalContribution {
  id          String   @id @default(uuid())
  goalId      String   @map("goal_id")
  amount      Decimal  @db.Decimal(14, 2)
  type        String
  date        DateTime @db.Date
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  goal UserGoal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@index([goalId])
  @@map("goal_contributions")
}

// =============================================
// USER PORTFOLIO HISTORY
// =============================================

model UserPortfolioHistory {
  id            Int      @id @default(autoincrement())
  userId        String   @map("user_id")
  clientId      String?  @map("client_id")
  date          DateTime @db.Date
  totalValue    Decimal  @map("total_value") @db.Decimal(14, 2)
  totalInvested Decimal  @map("total_invested") @db.Decimal(14, 2)
  dayChange     Decimal? @map("day_change") @db.Decimal(14, 2)
  dayChangePct  Decimal? @map("day_change_pct") @db.Decimal(8, 4)

  user   User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  client FAClient? @relation(fields: [clientId], references: [id])

  @@unique([userId, date])
  @@index([userId, date(sort: Desc)])
  @@index([clientId, date(sort: Desc)])
  @@map("user_portfolio_history")
}

// =============================================
// MARKET INDICES
// =============================================

model MarketIndex {
  id            String   @id @default(uuid())
  symbol        String   @unique
  name          String
  currentValue  Decimal  @map("current_value") @db.Decimal(14, 2)
  change        Decimal  @db.Decimal(10, 2)
  changePercent Decimal  @map("change_pct") @db.Decimal(8, 4)
  previousClose Decimal  @map("previous_close") @db.Decimal(14, 2)
  dayHigh       Decimal? @map("day_high") @db.Decimal(14, 2)
  dayLow        Decimal? @map("day_low") @db.Decimal(14, 2)
  lastUpdated   DateTime @map("last_updated")
  isActive      Boolean  @default(true) @map("is_active")

  history MarketIndexHistory[]

  @@map("market_indices")
}

model MarketIndexHistory {
  id      Int      @id @default(autoincrement())
  indexId String   @map("index_id")
  date    DateTime @db.Date
  open    Decimal  @db.Decimal(14, 2)
  high    Decimal  @db.Decimal(14, 2)
  low     Decimal  @db.Decimal(14, 2)
  close   Decimal  @db.Decimal(14, 2)
  volume  BigInt?

  index MarketIndex @relation(fields: [indexId], references: [id], onDelete: Cascade)

  @@unique([indexId, date])
  @@index([indexId, date(sort: Desc)])
  @@map("market_index_history")
}

// =============================================
// DIVIDENDS
// =============================================

model DividendRecord {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  clientId       String?  @map("client_id")
  fundName       String   @map("fund_name")
  fundSchemeCode String   @map("fund_scheme_code")
  amount         Decimal  @db.Decimal(14, 2)
  dividendType   String   @map("dividend_type")
  recordDate     DateTime @map("record_date") @db.Date
  paymentDate    DateTime @map("payment_date") @db.Date
  nav            Decimal? @db.Decimal(14, 4)
  units          Decimal? @db.Decimal(14, 4)
  createdAt      DateTime @default(now()) @map("created_at")

  user   User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  client FAClient? @relation(fields: [clientId], references: [id])

  @@index([userId])
  @@index([clientId])
  @@index([paymentDate])
  @@map("dividend_records")
}

// =============================================
// POINTS & REWARDS
// =============================================

enum PointsTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum PointsTransactionType {
  EARNED_SIP
  EARNED_LUMPSUM
  EARNED_REFERRAL
  EARNED_KYC
  EARNED_GOAL
  EARNED_STREAK
  REDEEMED
  EXPIRED
}

model UserPoints {
  id               String     @id @default(uuid())
  userId           String     @unique @map("user_id")
  currentPoints    Int        @default(0) @map("current_points")
  lifetimePoints   Int        @default(0) @map("lifetime_points")
  redeemedPoints   Int        @default(0) @map("redeemed_points")
  tier             PointsTier @default(BRONZE)
  tierUpdatedAt    DateTime?  @map("tier_updated_at")
  pointsToNextTier Int        @default(0) @map("points_to_next_tier")
  sipStreak        Int        @default(0) @map("sip_streak")
  createdAt        DateTime   @default(now()) @map("created_at")
  updatedAt        DateTime   @updatedAt @map("updated_at")

  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions PointsTransaction[]

  @@map("user_points")
}

model PointsTransaction {
  id           String                @id @default(uuid())
  userPointsId String                @map("user_points_id")
  type         PointsTransactionType
  points       Int
  description  String
  referenceId  String?               @map("reference_id")
  expiresAt    DateTime?             @map("expires_at")
  createdAt    DateTime              @default(now()) @map("created_at")

  userPoints UserPoints @relation(fields: [userPointsId], references: [id], onDelete: Cascade)

  @@index([userPointsId])
  @@index([createdAt])
  @@map("points_transactions")
}

// =============================================
// TAX TRACKING
// =============================================

enum GainType {
  LTCG
  STCG
}

model UserTaxSummary {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  financialYear     String   @map("financial_year")
  ltcgRealized      Decimal  @default(0) @map("ltcg_realized") @db.Decimal(14, 2)
  stcgRealized      Decimal  @default(0) @map("stcg_realized") @db.Decimal(14, 2)
  ltcgUnrealized    Decimal  @default(0) @map("ltcg_unrealized") @db.Decimal(14, 2)
  stcgUnrealized    Decimal  @default(0) @map("stcg_unrealized") @db.Decimal(14, 2)
  elssInvested      Decimal  @default(0) @map("elss_invested") @db.Decimal(14, 2)
  dividendReceived  Decimal  @default(0) @map("dividend_received") @db.Decimal(14, 2)
  taxHarvestingDone Decimal  @default(0) @map("tax_harvesting_done") @db.Decimal(14, 2)
  updatedAt         DateTime @updatedAt @map("updated_at")

  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  capitalGains CapitalGainRecord[]

  @@unique([userId, financialYear])
  @@map("user_tax_summaries")
}

model CapitalGainRecord {
  id             String   @id @default(uuid())
  taxSummaryId   String   @map("tax_summary_id")
  fundName       String   @map("fund_name")
  fundSchemeCode String   @map("fund_scheme_code")
  gainType       GainType @map("gain_type")
  purchaseDate   DateTime @map("purchase_date") @db.Date
  saleDate       DateTime @map("sale_date") @db.Date
  purchaseValue  Decimal  @map("purchase_value") @db.Decimal(14, 2)
  saleValue      Decimal  @map("sale_value") @db.Decimal(14, 2)
  gain           Decimal  @db.Decimal(14, 2)
  taxableGain    Decimal  @map("taxable_gain") @db.Decimal(14, 2)
  createdAt      DateTime @default(now()) @map("created_at")

  taxSummary UserTaxSummary @relation(fields: [taxSummaryId], references: [id], onDelete: Cascade)

  @@index([taxSummaryId])
  @@map("capital_gain_records")
}

// =============================================
// CONNECTED BROKER ACCOUNTS
// =============================================

enum BrokerConnectionStatus {
  CONNECTED
  DISCONNECTED
  PENDING
  FAILED
}

model ConnectedBrokerAccount {
  id               String                 @id @default(uuid())
  userId           String                 @map("user_id")
  brokerName       String                 @map("broker_name")
  brokerLogo       String?                @map("broker_logo")
  status           BrokerConnectionStatus @default(PENDING)
  accountId        String?                @map("account_id")
  lastSyncAt       DateTime?              @map("last_sync_at")
  accessToken      String?                @map("access_token")
  refreshToken     String?                @map("refresh_token")
  tokenExpiresAt   DateTime?              @map("token_expires_at")
  importedHoldings Boolean                @default(false) @map("imported_holdings")
  createdAt        DateTime               @default(now()) @map("created_at")
  updatedAt        DateTime               @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, brokerName])
  @@map("connected_broker_accounts")
}

// =============================================
// ADVISOR PROFILES
// =============================================

model AdvisorProfile {
  id              String   @id @default(uuid())
  userId          String   @unique @map("user_id")
  displayName     String   @map("display_name")
  bio             String?
  specializations String[]
  experienceYears Int      @map("experience_years")
  sebiRegNo       String?  @map("sebi_reg_no")
  arnNo           String?  @map("arn_no")
  rating          Decimal  @default(0) @db.Decimal(3, 2)
  totalReviews    Int      @default(0) @map("total_reviews")
  totalClients    Int      @default(0) @map("total_clients")
  aumManaged      Decimal  @default(0) @map("aum_managed") @db.Decimal(16, 2)
  isAcceptingNew  Boolean  @default(true) @map("is_accepting_new")
  minInvestment   Decimal? @map("min_investment") @db.Decimal(14, 2)
  feeStructure    String?  @map("fee_structure")
  avatarUrl       String?  @map("avatar_url")
  companyName     String?  @map("company_name")
  companyLogoUrl  String?  @map("company_logo_url")
  city            String?
  languages       String[]
  isVerified      Boolean  @default(false) @map("is_verified")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviews AdvisorReview[]

  @@map("advisor_profiles")
}

model AdvisorReview {
  id               String   @id @default(uuid())
  advisorProfileId String   @map("advisor_profile_id")
  reviewerId       String   @map("reviewer_id")
  rating           Int
  comment          String?
  isAnonymous      Boolean  @default(false) @map("is_anonymous")
  createdAt        DateTime @default(now()) @map("created_at")

  advisorProfile AdvisorProfile @relation(fields: [advisorProfileId], references: [id], onDelete: Cascade)
  reviewer       User           @relation("ReviewerReviews", fields: [reviewerId], references: [id])

  @@unique([advisorProfileId, reviewerId])
  @@map("advisor_reviews")
}

// =============================================
// AI CHAT
// =============================================

model AIChatSession {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  title     String?
  context   Json?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages AIChatMessage[]

  @@index([userId])
  @@map("ai_chat_sessions")
}

model AIChatMessage {
  id        String   @id @default(uuid())
  sessionId String   @map("session_id")
  role      String
  content   String
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  session AIChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@map("ai_chat_messages")
}

// =============================================
// NOTIFICATION SYSTEM
// =============================================

enum NotificationChannel {
  EMAIL
  WHATSAPP
  PUSH
}

enum NotificationCategory {
  TRADE_ALERTS
  SIP_REMINDERS
  CLIENT_REQUESTS
  MARKET_UPDATES
  DAILY_DIGEST
  PORTFOLIO_ALERTS
  KYC_ALERTS
  INSURANCE_REMINDERS
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
}

enum CommunicationType {
  PORTFOLIO_SUMMARY
  SIP_FAILURE_ALERT
  SIP_PAYMENT_REMINDER
  GOAL_PROGRESS_UPDATE
  TRANSACTION_CONFIRMATION
  REPORT_SHARING
  KYC_REMINDER
  CUSTOM
}

// =============================================
// BUSINESS MANAGEMENT ENUMS
// =============================================

enum StaffRole {
  RM
  OPERATIONS
  COMPLIANCE_OFFICER
  BRANCH_MANAGER
  SENIOR_ADVISOR
}

enum CommissionStatus {
  EXPECTED
  RECEIVED
  DISCREPANCY
  RECONCILED
}

enum BrokerageUploadStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum BrokerageSource {
  CAMS
  KFINTECH
  MANUAL
}

enum CRMTaskStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum CRMTaskCategory {
  FOLLOW_UP
  REVIEW
  ONBOARDING
  KYC_UPDATE
  COMPLAINT
  GENERAL
}

enum CRMActivityType {
  CALL
  EMAIL
  MEETING
  NOTE
  TASK_CREATED
  TASK_COMPLETED
}

enum ComplianceType {
  ARN
  EUIN
  KYC
  SEBI_REGISTRATION
  INSURANCE_LICENSE
}

enum ComplianceStatus {
  VALID
  EXPIRING_SOON
  EXPIRED
}

model NotificationPreference {
  id        String              @id @default(uuid())
  userId    String              @map("user_id")
  category  NotificationCategory
  channel   NotificationChannel
  enabled   Boolean             @default(true)
  createdAt DateTime            @default(now()) @map("created_at")
  updatedAt DateTime            @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, category, channel])
  @@index([userId])
  @@map("notification_preferences")
}

model NotificationLog {
  id         String             @id @default(uuid())
  userId     String             @map("user_id")
  category   NotificationCategory
  channel    NotificationChannel
  status     NotificationStatus @default(PENDING)
  subject    String?
  body       String?
  externalId String?            @map("external_id")
  error      String?
  sentAt     DateTime?          @map("sent_at")
  createdAt  DateTime           @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@index([status])
  @@map("notification_logs")
}

model FACommunicationLog {
  id         String              @id @default(uuid())
  advisorId  String              @map("advisor_id")
  clientId   String              @map("client_id")
  channel    NotificationChannel
  type       CommunicationType
  subject    String?
  body       String              @db.Text
  status     NotificationStatus  @default(PENDING)
  externalId String?             @map("external_id")
  error      String?
  metadata   Json?
  sentAt     DateTime?           @map("sent_at")
  createdAt  DateTime            @default(now()) @map("created_at")

  advisor User     @relation("AdvisorCommunications", fields: [advisorId], references: [id])
  client  FAClient @relation("ClientCommunications", fields: [clientId], references: [id])

  @@index([advisorId, createdAt(sort: Desc)])
  @@index([clientId])
  @@map("fa_communication_logs")
}

model FAStaffMember {
  id           String     @id @default(uuid())
  ownerId      String     @map("owner_id")
  staffUserId  String     @unique @map("staff_user_id")
  displayName  String     @map("display_name")
  allowedPages String[]   @map("allowed_pages")
  staffRole    StaffRole  @default(RM) @map("staff_role")
  euin         String?
  euinExpiry   DateTime?  @map("euin_expiry") @db.Date
  branchId     String?    @map("branch_id")
  isActive     Boolean    @default(true) @map("is_active")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  owner     User    @relation("FAStaffOwner", fields: [ownerId], references: [id])
  staffUser User    @relation("FAStaffUser", fields: [staffUserId], references: [id], onDelete: Cascade)
  branch    Branch? @relation(fields: [branchId], references: [id])

  // CRM relations
  assignedTasks  CRMTask[]        @relation("TaskAssignee")
  activityLogs   CRMActivityLog[]

  @@unique([ownerId, staffUserId])
  @@index([ownerId])
  @@index([branchId])
  @@map("fa_staff_members")
}

// =============================================
// USER ACTIONS / REMINDERS
// =============================================

enum ActionType {
  SIP_DUE
  SIP_FAILED
  REBALANCE_RECOMMENDED
  GOAL_REVIEW
  TAX_HARVESTING
  KYC_EXPIRY
  DIVIDEND_RECEIVED
  NAV_ALERT
  PREMIUM_DUE
  PREMIUM_OVERDUE
  POLICY_RENEWAL
  POLICY_MATURITY
  CUSTOM
}

enum ActionPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model UserAction {
  id          String         @id @default(uuid())
  userId      String         @map("user_id")
  type        ActionType
  priority    ActionPriority @default(MEDIUM)
  title       String
  description String?
  actionUrl   String?        @map("action_url")
  referenceId String?        @map("reference_id")
  dueDate     DateTime?      @map("due_date")
  isRead      Boolean        @default(false) @map("is_read")
  isDismissed Boolean        @default(false) @map("is_dismissed")
  isCompleted Boolean        @default(false) @map("is_completed")
  createdAt   DateTime       @default(now()) @map("created_at")
  expiresAt   DateTime?      @map("expires_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isCompleted, isDismissed])
  @@index([dueDate])
  @@map("user_actions")
}

// =============================================
// SAVED DEEP ANALYSIS
// =============================================

enum AnalysisStatus {
  DRAFT
  FINAL
  SHARED
}

model SavedAnalysis {
  id             String         @id @default(uuid())
  advisorId      String         @map("advisor_id")
  clientId       String         @map("client_id")
  title          String
  status         AnalysisStatus @default(DRAFT)
  latestVersion  Int            @default(1) @map("latest_version")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  advisor  User              @relation("AdvisorSavedAnalyses", fields: [advisorId], references: [id])
  client   FAClient          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  versions AnalysisVersion[]

  @@index([advisorId])
  @@index([clientId])
  @@map("saved_analyses")
}

model AnalysisVersion {
  id              String   @id @default(uuid())
  analysisId      String   @map("analysis_id")
  versionNumber   Int      @map("version_number")
  personaData     Json     @map("persona_data")
  riskData        Json     @map("risk_data")
  rebalancingData Json     @map("rebalancing_data")
  editNotes       String?  @map("edit_notes")
  createdAt       DateTime @default(now()) @map("created_at")

  analysis SavedAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  @@unique([analysisId, versionNumber])
  @@map("analysis_versions")
}

// =============================================
// FA PORTAL - INSURANCE TRACKING
// =============================================

model InsurancePolicy {
  id               String                @id @default(uuid())
  clientId         String                @map("client_id")
  client           FAClient              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  policyNumber     String                @map("policy_number")
  provider         String
  type             InsurancePolicyType
  status           InsurancePolicyStatus @default(ACTIVE)
  sumAssured       Decimal               @map("sum_assured") @db.Decimal(15, 2)
  premiumAmount    Decimal               @map("premium_amount") @db.Decimal(12, 2)
  premiumFrequency String                @default("ANNUAL") @map("premium_frequency")
  startDate        DateTime              @map("start_date")
  maturityDate     DateTime?             @map("maturity_date")
  nominees         String?
  notes            String?
  nextPremiumDate  DateTime?             @map("next_premium_date")
  lastPremiumDate  DateTime?             @map("last_premium_date")
  createdAt        DateTime              @default(now()) @map("created_at")
  updatedAt        DateTime              @updatedAt @map("updated_at")

  payments         PremiumPayment[]
  documents        PolicyDocument[]

  @@index([clientId])
  @@map("insurance_policies")
}

model PremiumPayment {
  id            String          @id @default(uuid())
  policyId      String          @map("policy_id")
  policy        InsurancePolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)
  amountPaid    Decimal         @map("amount_paid") @db.Decimal(12, 2)
  paymentDate   DateTime        @map("payment_date")
  paymentMode   String?         @map("payment_mode")
  receiptNumber String?         @map("receipt_number")
  notes         String?
  createdAt     DateTime        @default(now()) @map("created_at")

  @@index([policyId])
  @@map("premium_payments")
}

model PolicyDocument {
  id         String          @id @default(uuid())
  policyId   String          @map("policy_id")
  policy     InsurancePolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)
  fileName   String          @map("file_name")
  fileKey    String          @map("file_key")
  mimeType   String          @map("mime_type")
  fileSize   Int             @map("file_size")
  uploadedAt DateTime        @default(now()) @map("uploaded_at")

  @@index([policyId])
  @@map("policy_documents")
}

// =============================================
// BUSINESS MANAGEMENT - BRANCHES
// =============================================

model Branch {
  id        String   @id @default(uuid())
  advisorId String   @map("advisor_id")
  name      String
  city      String?
  code      String?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  advisor User            @relation(fields: [advisorId], references: [id])
  staff   FAStaffMember[]

  @@unique([advisorId, code])
  @@index([advisorId])
  @@map("branches")
}

// =============================================
// BUSINESS MANAGEMENT - COMMISSION TRACKING
// =============================================

model CommissionRateMaster {
  id               String    @id @default(uuid())
  advisorId        String    @map("advisor_id")
  amcId            String    @map("amc_id")
  schemeCategory   String    @map("scheme_category")
  trailRatePercent Decimal   @map("trail_rate_percent") @db.Decimal(6, 4)
  upfrontRatePercent Decimal @default(0) @map("upfront_rate_percent") @db.Decimal(6, 4)
  effectiveFrom    DateTime  @map("effective_from") @db.Date
  effectiveTo      DateTime? @map("effective_to") @db.Date
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  advisor  User     @relation(fields: [advisorId], references: [id])
  amc      Provider @relation(fields: [amcId], references: [id])

  @@index([advisorId])
  @@index([amcId])
  @@map("commission_rate_master")
}

model CommissionRecord {
  id           String           @id @default(uuid())
  advisorId    String           @map("advisor_id")
  period       String           // "2026-01", "2026-02", etc.
  amcId        String           @map("amc_id")
  aumAmount    Decimal          @default(0) @map("aum_amount") @db.Decimal(16, 2)
  expectedTrail Decimal         @default(0) @map("expected_trail") @db.Decimal(14, 2)
  actualTrail  Decimal          @default(0) @map("actual_trail") @db.Decimal(14, 2)
  status       CommissionStatus @default(EXPECTED)
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")

  advisor User @relation(fields: [advisorId], references: [id])

  @@unique([advisorId, period, amcId])
  @@index([advisorId])
  @@index([period])
  @@map("commission_records")
}

model BrokerageUpload {
  id          String                @id @default(uuid())
  advisorId   String                @map("advisor_id")
  fileName    String                @map("file_name")
  fileUrl     String?               @map("file_url")
  source      BrokerageSource       @default(MANUAL)
  recordCount Int                   @default(0) @map("record_count")
  status      BrokerageUploadStatus @default(PENDING)
  parsedData  Json?                 @map("parsed_data")
  errorMessage String?              @map("error_message")
  createdAt   DateTime              @default(now()) @map("created_at")
  updatedAt   DateTime              @updatedAt @map("updated_at")

  advisor User @relation(fields: [advisorId], references: [id])

  @@index([advisorId])
  @@map("brokerage_uploads")
}

// =============================================
// BUSINESS MANAGEMENT - AUM SNAPSHOTS
// =============================================

model AUMSnapshot {
  id          String   @id @default(uuid())
  advisorId   String   @map("advisor_id")
  date        DateTime @db.Date
  totalAum    Decimal  @default(0) @map("total_aum") @db.Decimal(16, 2)
  equityAum   Decimal  @default(0) @map("equity_aum") @db.Decimal(16, 2)
  debtAum     Decimal  @default(0) @map("debt_aum") @db.Decimal(16, 2)
  hybridAum   Decimal  @default(0) @map("hybrid_aum") @db.Decimal(16, 2)
  clientCount Int      @default(0) @map("client_count")
  sipBookSize Decimal  @default(0) @map("sip_book_size") @db.Decimal(14, 2)
  netFlows    Decimal  @default(0) @map("net_flows") @db.Decimal(14, 2)
  createdAt   DateTime @default(now()) @map("created_at")

  advisor User @relation(fields: [advisorId], references: [id])

  @@unique([advisorId, date])
  @@index([advisorId, date(sort: Desc)])
  @@map("aum_snapshots")
}

// =============================================
// BUSINESS MANAGEMENT - CRM
// =============================================

model CRMTask {
  id           String          @id @default(uuid())
  advisorId    String          @map("advisor_id")
  clientId     String?         @map("client_id")
  assignedToId String?         @map("assigned_to_id")
  title        String
  description  String?
  dueDate      DateTime?       @map("due_date") @db.Date
  priority     ActionPriority  @default(MEDIUM)
  status       CRMTaskStatus   @default(OPEN)
  category     CRMTaskCategory @default(GENERAL)
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")

  advisor    User           @relation("TaskAdvisor", fields: [advisorId], references: [id])
  client     FAClient?      @relation(fields: [clientId], references: [id])
  assignedTo FAStaffMember? @relation("TaskAssignee", fields: [assignedToId], references: [id])

  @@index([advisorId])
  @@index([clientId])
  @@index([assignedToId])
  @@index([status])
  @@index([dueDate])
  @@map("crm_tasks")
}

model CRMActivityLog {
  id        String          @id @default(uuid())
  advisorId String          @map("advisor_id")
  clientId  String?         @map("client_id")
  staffId   String?         @map("staff_id")
  type      CRMActivityType
  summary   String
  details   String?
  createdAt DateTime        @default(now()) @map("created_at")

  advisor User           @relation("ActivityAdvisor", fields: [advisorId], references: [id])
  client  FAClient?      @relation(fields: [clientId], references: [id])
  staff   FAStaffMember? @relation(fields: [staffId], references: [id])

  @@index([advisorId, createdAt(sort: Desc)])
  @@index([clientId])
  @@index([staffId])
  @@map("crm_activity_logs")
}

// =============================================
// BUSINESS MANAGEMENT - COMPLIANCE
// =============================================

model ComplianceRecord {
  id          String           @id @default(uuid())
  advisorId   String           @map("advisor_id")
  type        ComplianceType
  entityId    String?          @map("entity_id") // Staff ID, Client ID, or Advisor ID
  entityName  String?          @map("entity_name")
  expiryDate  DateTime         @map("expiry_date") @db.Date
  status      ComplianceStatus @default(VALID)
  documentUrl String?          @map("document_url")
  notes       String?
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  advisor User @relation(fields: [advisorId], references: [id])

  @@index([advisorId])
  @@index([type])
  @@index([status])
  @@index([expiryDate])
  @@map("compliance_records")
}

// =============================================
// BUSINESS MANAGEMENT - AUDIT LOG
// =============================================

model AuditLog {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  action     String
  entityType String   @map("entity_type")
  entityId   String?  @map("entity_id")
  oldValue   Json?    @map("old_value")
  newValue   Json?    @map("new_value")
  ipAddress  String?  @map("ip_address")
  createdAt  DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt(sort: Desc)])
  @@map("audit_logs")
}
